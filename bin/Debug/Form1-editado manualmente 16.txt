using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net.NetworkInformation;
using System.Reflection;
using System.Security;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Diagnostics;
using System.Security.Principal;

namespace Script_de_Cache
{
    public class DriverInfo
    {
        public string Name { get; set; }
        public string SilentArgs { get; set; }
        public string Description { get; set; }
        public string FileName { get; set; }
        public bool IsSelected { get; set; } = true;
    }

    public partial class Form1 : Form
    {
        // ===== CREDENCIAIS DO AD =====
        private readonly Dictionary<string, string> AD_ACCOUNTS = new Dictionary<string, string>
        {
            { "dpcorreia", "senha" }
        };

        // ===== CREDENCIAIS LOCAIS =====
        private readonly Dictionary<string, string> LOCAL_ACCOUNTS = new Dictionary<string, string>
        {
            { "adminvix", "senha" },
            { "Administrador", "senha" }
        };

        private const string DOMAIN = "PMV";
        private const string DOMAIN_CONTROLLER = "pmv.local";

        private string chosenUsername = null;
        private SecureString chosenPassword = null;
        private bool isDomainReachable = false;

        private string downloadDir;
        private string logFile;
        private List<DriverInfo> allDrivers;

        // Componentes da UI de SeleÃ§Ã£o
        private Panel selectionPanel;
        private Panel buttonsPanel;
        private Button btnInstall;
        private Button btnSelectAll;
        private Button btnDeselectAll;
        private Label lblTitle;
        private List<CheckBox> driverCheckBoxes;

        // Componentes da UI de Progresso
        private Panel progressPanel;
        private ProgressBar progressBar;
        private Label lblStatus;
        private Label lblProgressInfo;

        private bool isInstalling = false;

        public Form1()
        {
            InitializeComponent();
            InitializeCustomComponents();
            InitializeDirectories();
            CheckDomainAndSelectAccount();
            InitializeDrivers();
            CreateSelectionInterface();
        }

        private void CheckDomainAndSelectAccount()
        {
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage("VERIFICAÃ‡ÃƒO DO AMBIENTE");
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Verifica conectividade com domÃ­nio
            LogMessage($"DomÃ­nio: {DOMAIN}");
            LogMessage($"DC: {DOMAIN_CONTROLLER}");

            isDomainReachable = IsDomainControllerReachable(DOMAIN_CONTROLLER);

            LogMessage($"DomÃ­nio acessÃ­vel? {(isDomainReachable ? "SIM âœ“" : "NÃƒO âœ—")}");

            if (!isDomainReachable)
            {
                LogMessage("âš ï¸ AVISO: DomÃ­nio nÃ£o acessÃ­vel!");
                LogMessage("   TentarÃ¡ usar contas locais na instalaÃ§Ã£o.");
            }

            LogMessage("");

            // Lista contas disponÃ­veis
            LogMessage($"Contas AD disponÃ­veis: {AD_ACCOUNTS.Count}");
            foreach (var account in AD_ACCOUNTS.Keys)
            {
                LogMessage($"  â†’ {DOMAIN}\\{account}");
            }

            LogMessage($"Contas locais disponÃ­veis: {LOCAL_ACCOUNTS.Count}");
            foreach (var account in LOCAL_ACCOUNTS.Keys)
            {
                LogMessage($"  â†’ {Environment.MachineName}\\{account}");
            }

            // Escolhe primeira conta AD
            if (AD_ACCOUNTS.Count > 0)
            {
                var firstAccount = AD_ACCOUNTS.First();
                chosenUsername = firstAccount.Key;

                chosenPassword = new SecureString();
                foreach (char c in firstAccount.Value)
                {
                    chosenPassword.AppendChar(c);
                }
                chosenPassword.MakeReadOnly();

                LogMessage($"Conta AD selecionada: {DOMAIN}\\{chosenUsername}");
            }
            else
            {
                LogMessage("âš ï¸ AVISO: Nenhuma conta AD configurada!");
            }

            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage("");
        }

        private bool IsDomainControllerReachable(string dcName)
        {
            try
            {
                LogMessage($"  â†’ Testando ping em {dcName}...");

                System.Net.NetworkInformation.Ping ping = new System.Net.NetworkInformation.Ping();
                var reply = ping.Send(dcName, 3000);

                if (reply.Status == System.Net.NetworkInformation.IPStatus.Success)
                {
                    LogMessage($"  âœ“ Ping OK ({reply.RoundtripTime}ms)");
                    return true;
                }

                LogMessage($"  âœ— Ping falhou: {reply.Status}");
                return false;
            }
            catch (Exception ex)
            {
                LogMessage($"  âœ— Erro: {ex.Message}");
                return false;
            }
        }

        private void InitializeCustomComponents()
        {
            this.Text = "Instalador de Drivers - Selecione os Drivers";
            this.Size = new Size(800, 600);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = true;
            this.BackColor = Color.FromArgb(245, 245, 245);

            try
            {
                this.Icon = new Icon("R.ico");
            }
            catch
            {
                this.Icon = SystemIcons.Application;
            }
        }

        private void InitializeDirectories()
        {
            downloadDir = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
                "Downloads", "token-drivers"
            );

            Directory.CreateDirectory(downloadDir);
            logFile = Path.Combine(downloadDir, $"instalacao_{DateTime.Now:yyyyMMdd_HHmmss}.log");

            LogMessage($"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage($"INSTALADOR DE DRIVERS - Iniciado em {DateTime.Now}");
            LogMessage($"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage($"DiretÃ³rio de trabalho: {downloadDir}");
            LogMessage($"Log: {logFile}");
            LogMessage("");
        }

        private void InitializeDrivers()
        {
            allDrivers = new List<DriverInfo>
            {
                new DriverInfo
                {
                    Name = "Feitian ePass2003 Setup v1.1.16.330",
                    SilentArgs = "/S",
                    Description = "Instalador completo ePass 2003",
                    FileName = "ePass2003-Setup_v1.1.16.330.exe",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "ePass Manager Admin 2003",
                    SilentArgs = "/S",
                    Description = "Ferramenta de gerenciamento ePass 2003",
                    FileName = "ePassManagerAdm_2003.exe",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "Instalador DXSafe Middleware v1.0.30",
                    SilentArgs = "/S",
                    Description = "Middleware para Token DX Safe (Soluti/Certisign)",
                    FileName = "Instalador DXSafe Middleware - 1.0.30.exe",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "Agape Assinador Desktop v16.0.28315",
                    SilentArgs = "/S",
                    Description = "Assinador digital Agape",
                    FileName = "Assinador_Agape_16_0_28315_86.exe",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "Safenet 10.7",
                    SilentArgs = "/quiet /norestart",
                    Description = "Assinador digital Safenet",
                    FileName = "Safenet_10.7.msi",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "SafeSign",
                    SilentArgs = "/S",
                    Description = "Assinador digital SafeSign",
                    FileName = "SafeSignIC30124-x64-win-tu-admin.exe",
                    IsSelected = false
                },
                new DriverInfo
                {
                    Name = "GD Starsign",
                    //SilentArgs = "/quiet",
                    // sem sucesso -SilentArgs = "/s /v\"/qb! /norestart REBOOT=ReallySuppress\"",
                    // fail SilentArgs = "/s /v\"/qn+ REBOOT=ReallySuppress /norestart\"",
                    // faill SilentArgs = "/silent /VERYSILENT /SUPPRESSMSGBOXES /NORESTART",
                    // fail SilentArgs = "/silent /VERYSILENT /SUPPRESSMSGBOXES /NORESTART",
                    Description = "Assinador digital GD",
                    FileName = "GDsetupStarsignCUTx64.exe",
                    IsSelected = false
                }
            };

            LogMessage($"Total de drivers configurados: {allDrivers.Count}");
            LogMessage("");
        }

        private void CreateSelectionInterface()
        {
            // ===== PAINEL PRINCIPAL DE SELEÃ‡ÃƒO =====
            selectionPanel = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = Color.FromArgb(245, 245, 245),
                Padding = new Padding(20),
                Visible = true
            };

            // TÃ­tulo
            lblTitle = new Label
            {
                Text = "Selecione o modelo do Token que deseja instalar:",
                Font = new Font("Segoe UI", 14, FontStyle.Bold),
                ForeColor = Color.FromArgb(50, 50, 50),
                AutoSize = true,
                Location = new Point(20, 20)
            };
            selectionPanel.Controls.Add(lblTitle);

            // Painel com scroll para os checkboxes
            Panel scrollPanel = new Panel
            {
                Location = new Point(20, 60),
                Size = new Size(740, 380),
                BackColor = Color.White,
                BorderStyle = BorderStyle.FixedSingle,
                AutoScroll = true
            };

            driverCheckBoxes = new List<CheckBox>();
            int yPos = 10;

            for (int i = 0; i < allDrivers.Count; i++)
            {
                var driver = allDrivers[i];

                Panel driverPanel = new Panel
                {
                    Location = new Point(10, yPos),
                    Size = new Size(700, 70),
                    BackColor = i % 2 == 0 ? Color.FromArgb(250, 250, 250) : Color.White
                };

                CheckBox chk = new CheckBox
                {
                    Location = new Point(10, 10),
                    Size = new Size(680, 25),
                    Font = new Font("Segoe UI", 11, FontStyle.Bold),
                    ForeColor = Color.FromArgb(50, 50, 50),
                    Checked = driver.IsSelected,
                    Text = driver.Name,
                    Tag = driver
                };
                chk.CheckedChanged += (s, e) => { driver.IsSelected = chk.Checked; };
                driverCheckBoxes.Add(chk);
                driverPanel.Controls.Add(chk);

                Label lblDesc = new Label
                {
                    Location = new Point(30, 40),
                    Size = new Size(650, 20),
                    Font = new Font("Segoe UI", 9, FontStyle.Italic),
                    ForeColor = Color.FromArgb(120, 120, 120),
                    Text = driver.Description
                };
                driverPanel.Controls.Add(lblDesc);

                scrollPanel.Controls.Add(driverPanel);
                yPos += 75;
            }

            selectionPanel.Controls.Add(scrollPanel);

            // ===== PAINEL DE BOTÃ•ES =====
            buttonsPanel = new Panel
            {
                Location = new Point(20, 450),
                Size = new Size(740, 80),
                BackColor = Color.FromArgb(245, 245, 245)
            };

            btnSelectAll = new Button
            {
                Location = new Point(0, 10),
                Size = new Size(150, 40),
                Text = "âœ“ Selecionar Todos",
                Font = new Font("Segoe UI", 10),
                BackColor = Color.FromArgb(100, 150, 200),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Cursor = Cursors.Hand
            };
            btnSelectAll.FlatAppearance.BorderSize = 0;
            btnSelectAll.Click += BtnSelectAll_Click;
            buttonsPanel.Controls.Add(btnSelectAll);

            btnDeselectAll = new Button
            {
                Location = new Point(160, 10),
                Size = new Size(150, 40),
                Text = "âœ— Desmarcar Todos",
                Font = new Font("Segoe UI", 10),
                BackColor = Color.FromArgb(150, 150, 150),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Cursor = Cursors.Hand
            };
            btnDeselectAll.FlatAppearance.BorderSize = 0;
            btnDeselectAll.Click += BtnDeselectAll_Click;
            buttonsPanel.Controls.Add(btnDeselectAll);

            btnInstall = new Button
            {
                Location = new Point(540, 10),
                Size = new Size(200, 50),
                Text = "ğŸš€ INSTALAR DRIVER(S)",
                Font = new Font("Segoe UI", 11, FontStyle.Bold),
                BackColor = Color.FromArgb(76, 175, 80),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Cursor = Cursors.Hand
            };
            btnInstall.FlatAppearance.BorderSize = 0;
            btnInstall.Click += BtnInstall_Click;
            buttonsPanel.Controls.Add(btnInstall);

            selectionPanel.Controls.Add(buttonsPanel);

            // ===== PAINEL DE PROGRESSO =====
            progressPanel = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = Color.FromArgb(245, 245, 245),
                Padding = new Padding(40),
                Visible = false
            };

            lblStatus = new Label
            {
                Text = "Preparando instalaÃ§Ã£o...",
                Font = new Font("Segoe UI", 12),
                ForeColor = Color.FromArgb(100, 100, 100),
                AutoSize = true,
                Location = new Point(40, 200)
            };
            progressPanel.Controls.Add(lblStatus);

            progressBar = new ProgressBar
            {
                Location = new Point(40, 240),
                Size = new Size(700, 40),
                Style = ProgressBarStyle.Continuous,
                BackColor = Color.FromArgb(220, 220, 220),
                ForeColor = Color.FromArgb(76, 175, 80)
            };
            progressPanel.Controls.Add(progressBar);

            lblProgressInfo = new Label
            {
                Text = "Aguarde...",
                Font = new Font("Segoe UI", 10, FontStyle.Italic),
                ForeColor = Color.FromArgb(150, 150, 150),
                AutoSize = true,
                Location = new Point(40, 290)
            };
            progressPanel.Controls.Add(lblProgressInfo);

            this.Controls.Add(selectionPanel);
            this.Controls.Add(progressPanel);
        }

        private void BtnSelectAll_Click(object sender, EventArgs e)
        {
            foreach (var chk in driverCheckBoxes)
            {
                chk.Checked = true;
            }
        }

        private void BtnDeselectAll_Click(object sender, EventArgs e)
        {
            foreach (var chk in driverCheckBoxes)
            {
                chk.Checked = false;
            }
        }

        private async void BtnInstall_Click(object sender, EventArgs e)
        {
            if (isInstalling) return;

            var selectedDrivers = allDrivers.Where(d => d.IsSelected).ToList();

            if (selectedDrivers.Count == 0)
            {
                MessageBox.Show(
                    "Por favor, selecione pelo menos um driver para instalar.",
                    "Nenhum driver selecionado",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning
                );
                return;
            }

            var result = MessageBox.Show(
                $"VocÃª selecionou {selectedDrivers.Count} driver(s) para instalaÃ§Ã£o.\n\n" +
                $"Deseja continuar?",
                "Confirmar InstalaÃ§Ã£o",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question
            );

            if (result != DialogResult.Yes)
                return;

            selectionPanel.Visible = false;
            progressPanel.Visible = true;
            isInstalling = true;

            await StartInstallation(selectedDrivers);
        }

        private async Task StartInstallation(List<DriverInfo> driversToInstall)
        {
            await Task.Delay(500);

            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage("ğŸš€ INICIANDO INSTALAÃ‡ÃƒO");
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            if (chosenUsername != null && isDomainReachable)
            {
                LogMessage($"Conta AD: {DOMAIN}\\{chosenUsername}");
            }

            if (LOCAL_ACCOUNTS.Count > 0)
            {
                LogMessage($"Contas locais configuradas: {LOCAL_ACCOUNTS.Count}");
            }

            LogMessage($"Total de drivers: {driversToInstall.Count}");
            LogMessage("");

            int successCount = 0;
            int failCount = 0;
            List<string> failedDrivers = new List<string>();

            for (int i = 0; i < driversToInstall.Count; i++)
            {
                var driverInfo = driversToInstall[i];
                UpdateProgress(i + 1, driversToInstall.Count);

                LogMessage($"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
                LogMessage($"[{i + 1}/{driversToInstall.Count}] {driverInfo.Name}");
                LogMessage($"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

                bool success = await Task.Run(() => InstallDriver(driverInfo));

                if (success)
                {
                    successCount++;
                    LogMessage($"âœ“ SUCESSO");
                }
                else
                {
                    failCount++;
                    failedDrivers.Add(driverInfo.Name);
                    LogMessage($"âœ— FALHA");
                }

                LogMessage("");
                await Task.Delay(1000);
            }

            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage($"ğŸ“Š RESUMO");
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage($"âœ“ Sucessos: {successCount}");
            LogMessage($"âœ— Falhas: {failCount}");

            if (failedDrivers.Count > 0)
            {
                LogMessage("");
                LogMessage("Drivers que falharam:");
                foreach (var driver in failedDrivers)
                {
                    LogMessage($"  âœ— {driver}");
                }
            }

            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            progressBar.Value = 100;
            lblStatus.Text = "ConcluÃ­do!";

            await Task.Delay(1000);

            string message = $"âœ“ {successCount} instalado(s)\n";
            if (failCount > 0)
            {
                message += $"âœ— {failCount} falharam\n\nLog: {logFile}";
            }
            message += "\n\nâš ï¸ Reinicie o computador!";

            MessageBox.Show(message, "ConcluÃ­do", MessageBoxButtons.OK, MessageBoxIcon.Information);

            if (failCount > 0)
            {
                var openLog = MessageBox.Show("Abrir log?", "Log", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (openLog == DialogResult.Yes)
                {
                    Process.Start("notepad.exe", logFile);
                }
            }

            Application.Exit();
        }

        private bool InstallDriver(DriverInfo driverInfo)
        {
            try
            {
                var assembly = Assembly.GetExecutingAssembly();
                string[] allResources = assembly.GetManifestResourceNames();

                LogMessage($"  â†’ Buscando: {driverInfo.FileName}");

                string resourceName = FindResource(allResources, driverInfo.FileName);
                if (string.IsNullOrEmpty(resourceName))
                {
                    LogMessage($"  âœ— Recurso nÃ£o encontrado");
                    return false;
                }

                LogMessage($"  âœ“ Encontrado: {resourceName}");

                Stream resourceStream = assembly.GetManifestResourceStream(resourceName);
                if (resourceStream == null)
                {
                    LogMessage($"  âœ— Stream nulo");
                    return false;
                }

                string extension = Path.GetExtension(driverInfo.FileName);
                string tempDir = @"C:\Temp";

                if (!Directory.Exists(tempDir))
                {
                    Directory.CreateDirectory(tempDir);
                }

                string tempPath = Path.Combine(tempDir, $"drv_{Guid.NewGuid().ToString("N").Substring(0, 8)}{extension}");

                LogMessage($"  â†’ Extraindo para: {tempPath}");

                using (FileStream fileStream = File.Create(tempPath))
                {
                    resourceStream.CopyTo(fileStream);
                }
                resourceStream.Close();

                long fileSize = new FileInfo(tempPath).Length;
                LogMessage($"  âœ“ ExtraÃ­do: {fileSize / 1024:N0} KB");

                System.Threading.Thread.Sleep(300);

                LogMessage($"  â†’ Iniciando instalaÃ§Ã£o...");

                bool installed = InstallWithCredentials(tempPath, driverInfo.SilentArgs);

                try
                {
                    if (File.Exists(tempPath))
                        File.Delete(tempPath);
                }
                catch { }

                return installed;
            }
            catch (Exception ex)
            {
                LogMessage($"  âœ— ExceÃ§Ã£o: {ex.Message}");
                return false;
            }
        }

        // ===== MÃ‰TODO PARA FECHAR APENAS JANELAS DE ERRO =====
        private void KillErrorWindows()
        {
            try
            {
                var processes = Process.GetProcesses();
                foreach (var process in processes)
                {
                    try
                    {
                        if (!string.IsNullOrEmpty(process.MainWindowTitle))
                        {
                            string title = process.MainWindowTitle;
                            string titleLower = title.ToLower();

                            // SÃ“ fecha janelas que REALMENTE sÃ£o de erro
                            // NÃƒO fecha o wizard do instalador
                            bool isErrorWindow =
                                titleLower.Contains("1628") ||
                                (titleLower.Contains("failed") && titleLower.Contains("complete")) ||
                                (titleLower.Contains("falhou") && !titleLower.Contains("wizard")) ||
                                (titleLower.Contains("error") && !titleLower.Contains("wizard") && !titleLower.Contains("installshield"));

                            // NÃƒO fecha se for o wizard principal
                            bool isWizard = titleLower.Contains("installshield wizard") && !titleLower.Contains("1628");

                            if (isErrorWindow && !isWizard)
                            {
                                LogMessage($"    âš¡ Fechando janela de erro: {title}");
                                process.CloseMainWindow();
                                System.Threading.Thread.Sleep(100);
                                if (!process.HasExited)
                                {
                                    process.Kill();
                                }
                            }
                        }
                    }
                    catch { }
                }
            }
            catch { }
        }

        private bool InstallWithCredentials(string filePath, string silentArgs)
        {
            // ===== TENTATIVA 1: CONTAS DO AD (se domÃ­nio acessÃ­vel) =====
            if (chosenUsername != null && chosenPassword != null && isDomainReachable)
            {
                LogMessage($"  â†’ Tentando autenticaÃ§Ã£o AD...");

                string[] domainsToTry = { DOMAIN, DOMAIN_CONTROLLER };

                foreach (string domain in domainsToTry)
                {
                    LogMessage($"  â†’ Tentativa com: {domain}\\{chosenUsername}");
                    bool success = TryInstallWithDomain(filePath, silentArgs, domain, chosenUsername, chosenPassword);
                    if (success) return true;
                }

                LogMessage($"  âœ— Todas as tentativas AD falharam");
            }

            // ===== TENTATIVA 2: CONTAS LOCAIS =====
            if (LOCAL_ACCOUNTS.Count > 0)
            {
                LogMessage($"  â†’ Tentando com contas locais...");

                foreach (var localAccount in LOCAL_ACCOUNTS)
                {
                    LogMessage($"  â†’ Tentativa com: {Environment.MachineName}\\{localAccount.Key}");

                    bool success = TryInstallWithLocalAccount(
                        filePath,
                        silentArgs,
                        localAccount.Key,
                        localAccount.Value
                    );

                    if (success) return true;
                }
            }

            LogMessage($"  âœ— Todas as tentativas falharam (AD + Local)");
            return false;
        }

        private bool TryInstallWithDomain(string filePath, string silentArgs, string domain, string username, SecureString password)
        {
            try
            {
                string extension = Path.GetExtension(filePath).ToLower();

                string fileName = extension == ".msi" ? "msiexec.exe" : filePath;
                string arguments = extension == ".msi"
                    ? $"/i \"{filePath}\" {silentArgs} /qn"
                    : silentArgs;

                LogMessage($"    â†’ Comando: {Path.GetFileName(fileName)} {silentArgs}");

                var psi = new ProcessStartInfo
                {
                    FileName = fileName,
                    Arguments = arguments,
                    Domain = domain,
                    UserName = username,
                    Password = password,
                    UseShellExecute = false,
                    LoadUserProfile = true,
                    CreateNoWindow = true,
                    WindowStyle = ProcessWindowStyle.Hidden
                };

                var proc = Process.Start(psi);

                if (proc == null)
                {
                    LogMessage($"    âœ— Processo nÃ£o iniciou");
                    return false;
                }

                LogMessage($"    â†’ PID: {proc.Id}, aguardando...");

                // Thread para fechar APENAS janelas de erro (nÃ£o o wizard)
                Task.Run(() =>
                {
                    while (!proc.HasExited)
                    {
                        KillErrorWindows();
                        System.Threading.Thread.Sleep(1000); // Aumentado para 1 segundo
                    }
                });

                bool finished = proc.WaitForExit(300000);

                if (!finished)
                {
                    LogMessage($"    âœ— TIMEOUT");
                    try { proc.Kill(); } catch { }
                    return false;
                }

                int exitCode = proc.ExitCode;
                LogMessage($"    â†’ Exit Code: {exitCode}");

                switch (exitCode)
                {
                    case 0:
                    case 3010:
                    case 1638:
                    case 1641:
                    case -1:     // Pode ter instalado mas retornou -1
                    case -3:     // GD Starsign
                    case 1628:   // InstallShield erro falso
                        LogMessage($"    âœ“ SUCESSO com {domain}\\{username} (cÃ³digo {exitCode})");
                        return true;
                    default:
                        LogMessage($"    âœ— Falhou (cÃ³digo {exitCode})");
                        return false;
                }
            }
            catch (System.ComponentModel.Win32Exception ex)
            {
                LogMessage($"    âœ— Win32: {ex.Message} (CÃ³digo: {ex.NativeErrorCode})");
                return false;
            }
            catch (Exception ex)
            {
                LogMessage($"    âœ— ExceÃ§Ã£o: {ex.Message}");
                return false;
            }
        }

        private bool TryInstallWithLocalAccount(string filePath, string silentArgs, string username, string password)
        {
            try
            {
                string extension = Path.GetExtension(filePath).ToLower();

                string fileName = extension == ".msi" ? "msiexec.exe" : filePath;
                string arguments = extension == ".msi"
                    ? $"/i \"{filePath}\" {silentArgs} /qn"
                    : silentArgs;

                LogMessage($"    â†’ Comando: {Path.GetFileName(fileName)} {silentArgs}");

                var securePassword = new SecureString();
                foreach (char c in password)
                {
                    securePassword.AppendChar(c);
                }
                securePassword.MakeReadOnly();

                var psi = new ProcessStartInfo
                {
                    FileName = fileName,
                    Arguments = arguments,
                    Domain = Environment.MachineName,
                    UserName = username,
                    Password = securePassword,
                    UseShellExecute = false,
                    LoadUserProfile = true,
                    CreateNoWindow = true,
                    WindowStyle = ProcessWindowStyle.Hidden
                };

                var proc = Process.Start(psi);

                if (proc == null)
                {
                    LogMessage($"    âœ— Processo nÃ£o iniciou");
                    return false;
                }

                LogMessage($"    â†’ PID: {proc.Id}, aguardando...");

                // Thread para fechar APENAS janelas de erro (nÃ£o o wizard)
                Task.Run(() =>
                {
                    while (!proc.HasExited)
                    {
                        KillErrorWindows();
                        System.Threading.Thread.Sleep(1000); // Aumentado para 1 segundo
                    }
                });

                bool finished = proc.WaitForExit(300000);

                if (!finished)
                {
                    LogMessage($"    âœ— TIMEOUT");
                    try { proc.Kill(); } catch { }
                    return false;
                }

                int exitCode = proc.ExitCode;
                LogMessage($"    â†’ Exit Code: {exitCode}");

                switch (exitCode)
                {
                    case 0:
                    case 3010:
                    case 1638:
                    case 1641:
                    case -1:     // Pode ter instalado mas retornou -1
                    case -3:     // GD Starsign
                    case 1628:   // InstallShield erro falso
                        LogMessage($"    âœ“ SUCESSO com {Environment.MachineName}\\{username} (cÃ³digo {exitCode})");
                        return true;
                    default:
                        LogMessage($"    âœ— Falhou (cÃ³digo {exitCode})");
                        return false;
                }
            }
            catch (System.ComponentModel.Win32Exception ex)
            {
                LogMessage($"    âœ— Win32: {ex.Message} (CÃ³digo: {ex.NativeErrorCode})");
                return false;
            }
            catch (Exception ex)
            {
                LogMessage($"    âœ— ExceÃ§Ã£o: {ex.Message}");
                return false;
            }
        }

        private string FindResource(string[] allResources, string fileName)
        {
            var match = allResources.FirstOrDefault(r =>
                r.EndsWith(fileName, StringComparison.OrdinalIgnoreCase));
            if (match != null) return match;

            string normalized = fileName.Replace(" ", "_").Replace("-", "_").Replace(".", "_").ToLower();
            match = allResources.FirstOrDefault(r =>
                r.Replace(" ", "_").Replace("-", "_").Replace(".", "_").ToLower().EndsWith(normalized));
            if (match != null) return match;

            string nameOnly = Path.GetFileNameWithoutExtension(fileName);
            match = allResources.FirstOrDefault(r =>
                r.IndexOf(nameOnly, StringComparison.OrdinalIgnoreCase) >= 0);

            return match;
        }

        private void LogMessage(string message)
        {
            string timestamp = DateTime.Now.ToString("HH:mm:ss");
            string logEntry = $"[{timestamp}] {message}";

            try
            {
                File.AppendAllText(logFile, logEntry + Environment.NewLine);
                Debug.WriteLine(logEntry);
            }
            catch { }
        }

        private void UpdateProgress(int current, int total)
        {
            int percentage = (current * 100) / total;

            if (progressBar.InvokeRequired)
            {
                progressBar.Invoke(new Action(() =>
                {
                    progressBar.Value = Math.Min(percentage, 100);
                    lblStatus.Text = $"Instalando {current} de {total}...";
                    lblProgressInfo.Text = $"{percentage}%";
                }));
            }
            else
            {
                progressBar.Value = Math.Min(percentage, 100);
                lblStatus.Text = $"Instalando {current} de {total}...";
                lblProgressInfo.Text = $"{percentage}%";
            }
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            base.OnFormClosing(e);
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            LogMessage($"Encerrado em {DateTime.Now}");
            LogMessage("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
    }
}
// teste 322